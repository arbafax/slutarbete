<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RAG Search System</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
      :root { 
        font-family: 'Roboto', sans-serif;
        --primary: #1976d2;
        --primary-dark: #1565c0;
        --primary-light: #42a5f5;
        --secondary: #388e3c;
        --error: #d32f2f;
        --background: #fafafa;
        --surface: #ffffff;
        --on-primary: #ffffff;
        --on-surface: rgba(0, 0, 0, 0.87);
        --on-surface-medium: rgba(0, 0, 0, 0.60);
        --on-surface-disabled: rgba(0, 0, 0, 0.38);
        --divider: rgba(0, 0, 0, 0.12);
      }
      * { box-sizing: border-box; }
      body { margin: 0; background: var(--background); color: var(--on-surface); line-height: 1.5; }
      .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
      .app-bar { background: var(--primary); color: var(--on-primary); padding: 16px 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); margin-bottom: 24px; }
      .app-bar h1 { margin: 0; font-size: 24px; font-weight: 400; }
      .app-bar p { margin: 8px 0 0 0; opacity: 0.9; font-size: 14px; }
      h2 { font-size: 20px; font-weight: 500; margin: 0 0 16px; display: flex; align-items: center; gap: 8px; }
      h3 { font-size: 16px; font-weight: 500; margin: 24px 0 12px; display: flex; align-items: center; gap: 8px; }
      .card { background: var(--surface); border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; }
      .zone { border: 2px dashed var(--divider); border-radius: 4px; padding: 48px 32px; text-align: center; transition: all 0.2s; background: #fafafa; margin-top: 16px; }
      .zone.dragover { border-color: var(--primary); background: #e3f2fd; }
      .btn { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-family: 'Roboto', sans-serif; font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s; background: transparent; color: var(--primary); }
      .btn:hover { background: rgba(25, 118, 210, 0.08); }
      .btn-raised { background: var(--primary); color: var(--on-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
      .btn-raised:hover { background: var(--primary-dark); }
      .btn-outlined { border: 1px solid var(--primary); }
      .btn:disabled { background: var(--on-surface-disabled); color: rgba(0,0,0,0.26); cursor: not-allowed; }
      .hidden { display: none !important; }
      .result { margin-top: 16px; padding: 16px; background: #e8f5e9; border-left: 4px solid var(--secondary); border-radius: 4px; }
      code { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 3px; font-size: 13px; }
      input[type="text"], input[type="url"], select, textarea { width: 100%; padding: 12px 16px; border: 1px solid var(--divider); border-bottom: 2px solid var(--divider); border-radius: 4px 4px 0 0; font-size: 16px; font-family: 'Roboto', sans-serif; }
      textarea { min-height: 120px; resize: vertical; line-height: 1.5; }
      input:focus, select:focus, textarea:focus { outline: none; border-bottom-color: var(--primary); }
      .input-group { display: flex; gap: 12px; align-items: flex-end; margin-top: 16px; }
      .input-group input, .input-group select { flex: 1; }
      .search-result { background: var(--surface); border-radius: 4px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
      .search-result:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.16); }
      .search-result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
      .search-result-title { font-weight: 500; font-size: 16px; margin: 0 0 4px 0; }
      .search-result-score { background: #e3f2fd; color: var(--primary); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
      .search-result-text { color: var(--on-surface-medium); font-size: 14px; line-height: 1.6; }
      .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0; }
      .stat-card { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 4px; }
      .stat-label { font-size: 12px; color: var(--on-surface-medium); text-transform: uppercase; font-weight: 500; }
      .stat-value { font-size: 32px; font-weight: 300; color: var(--primary); margin-top: 8px; }
      ul { padding-left: 20px; }
      li { margin: 8px 0; }
      a { color: var(--primary); text-decoration: none; }
      a:hover { text-decoration: underline; }
      .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .info-box { margin-top: 16px; padding: 16px; background: #e3f2fd; border-left: 4px solid var(--primary); border-radius: 4px; display: flex; gap: 12px; }
      .empty-state { text-align: center; padding: 48px 24px; color: var(--on-surface-medium); }
      .empty-state .material-icons { font-size: 64px; color: var(--on-surface-disabled); margin-bottom: 16px; }
      label { display: block; font-size: 12px; color: var(--on-surface-medium); margin-bottom: 4px; font-weight: 500; }
      .text-muted { color: var(--on-surface-medium); font-size: 13px; }
      .ai-answer-box { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; padding: 20px; }
      .ai-answer-text { white-space: pre-wrap; line-height: 1.7; }
      .mode-selector { display: flex; gap: 8px; margin-bottom: 16px; }
      .mode-btn { flex: 1; padding: 12px; border: 2px solid var(--divider); border-radius: 4px; background: white; cursor: pointer; text-align: center; font-weight: 500; transition: all 0.2s; }
      .mode-btn:hover { background: #f5f5f5; }
      .mode-btn.active { border-color: var(--primary); background: #e3f2fd; color: var(--primary); }
      .url-list { background: #f5f5f5; border-radius: 4px; padding: 12px; margin-top: 12px; max-height: 200px; overflow-y: auto; }
      .url-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px; margin-bottom: 8px; font-size: 13px; }
      .url-item:last-child { margin-bottom: 0; }
      .url-item-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .url-item-remove { color: var(--error); cursor: pointer; padding: 4px; }
      .url-item-remove:hover { background: rgba(211, 47, 47, 0.1); border-radius: 50%; }
    </style>
  </head>
  <body>
    <div class="app-bar">
      <h1>RAG Search System</h1>
      <p>Ladda upp PDF-filer, extrahera text från webbsidor, och sök semantiskt med AI</p>
    </div>

    <div class="wrap">
      <!-- PDF Upload -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">PDF med Semantisk Sökning</h2>
          <button class="btn btn-outlined" id="clearPdfBtn" style="text-transform: none;">
            <span class="material-icons">clear</span> Rensa
          </button>
        </div>
        <p class="text-muted">Ladda upp en eller flera PDFs så skapas automatiskt embeddings för semantisk sökning.</p>
        
        <!-- Mode Selector for PDF -->
        <div class="mode-selector">
          <div class="mode-btn active" id="pdfModeSingle">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">description</span>
            En PDF
          </div>
          <div class="mode-btn" id="pdfModeMultiple">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">content_copy</span>
            Flera PDFs
          </div>
          <div class="mode-btn" id="pdfModeAddToExisting">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">add</span>
            Lägg till i befintlig
          </div>
        </div>

        <!-- Single PDF Mode -->
        <div id="singlePdfMode">
          <div style="margin-bottom: 16px;">
            <label>Samlingens namn (valfritt)</label>
            <input id="pdfCollectionName" type="text" placeholder="T.ex. 'Årsredovisning 2024' eller lämna tomt för automatiskt namn" />
          </div>
          
          <div class="input-group" style="margin-bottom: 16px;">
            <div style="flex: 1;"><label>Embedding Model</label>
              <select id="pdfEmbedBackend">
                <option value="google">Google (Standard)</option>
                <option value="openai">OpenAI</option>
                <option value="sbert">Sentence-BERT</option>
                <option value="ollama">Ollama (Lokal)</option>
              </select>
            </div>
            <div style="flex: 1;"><label>Chunk-storlek</label>
              <select id="pdfChunkSize">
                <option value="256">256 tokens</option>
                <option value="512" selected>512 tokens</option>
                <option value="1024">1024 tokens</option>
              </select>
            </div>
          </div>
          <div id="dropzone" class="zone">
            <span class="material-icons" style="font-size: 48px; color: var(--on-surface-disabled);">cloud_upload</span>
            <p><strong>Släpp PDF här</strong></p>
            <p class="text-muted">eller</p>
            <label class="btn btn-outlined" for="file"><span class="material-icons">folder_open</span> Välj PDF</label>
            <input class="hidden" id="file" type="file" accept="application/pdf" />
          </div>
        </div>

        <!-- Multiple PDFs Mode -->
        <div id="multiplePdfsMode" class="hidden">
          <div style="margin-bottom: 16px;">
            <label>Samlingens namn (obligatoriskt)</label>
            <input id="multiPdfCollectionName" type="text" placeholder="T.ex. 'Företagsdokument 2024'" />
          </div>

          <div class="input-group" style="margin-bottom: 16px;">
            <div style="flex: 1;"><label>Embedding Model</label>
              <select id="multiPdfEmbedBackend">
                <option value="google">Google (Standard)</option>
                <option value="openai">OpenAI</option>
                <option value="sbert">Sentence-BERT</option>
                <option value="ollama">Ollama (Lokal)</option>
              </select>
            </div>
            <div style="flex: 1;"><label>Chunk-storlek</label>
              <select id="multiPdfChunkSize">
                <option value="256">256 tokens</option>
                <option value="512" selected>512 tokens</option>
                <option value="1024">1024 tokens</option>
              </select>
            </div>
          </div>

          <div class="zone" id="multiDropzone">
            <span class="material-icons" style="font-size: 48px; color: var(--on-surface-disabled);">cloud_upload</span>
            <p><strong>Släpp flera PDFs här</strong></p>
            <p class="text-muted">eller</p>
            <label class="btn btn-outlined" for="multiFile"><span class="material-icons">folder_open</span> Välj flera PDFs</label>
            <input class="hidden" id="multiFile" type="file" accept="application/pdf" multiple />
          </div>

          <div id="multiPdfProgress" style="display: none; margin-top: 16px;">
            <div style="background: #e0e0e0; border-radius: 4px; height: 8px; overflow: hidden;">
              <div id="multiPdfProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p id="multiPdfProgressText" class="text-muted" style="margin-top: 8px; text-align: center;">0 / 0</p>
          </div>
        </div>

        <!-- Add to Existing Mode -->
        <div id="addPdfToExistingMode" class="hidden">
          <div style="margin-bottom: 16px;">
            <label>Välj befintlig samling</label>
            <select id="existingPdfCollectionSelect">
              <option value="">-- Välj samling --</option>
            </select>
          </div>

          <div class="input-group" style="margin-bottom: 16px;">
            <div style="flex: 1;"><label>Embedding Model</label>
              <select id="addPdfEmbedBackend">
                <option value="google">Google (Standard)</option>
                <option value="openai">OpenAI</option>
                <option value="sbert">Sentence-BERT</option>
                <option value="ollama">Ollama (Lokal)</option>
              </select>
            </div>
            <div style="flex: 1;"><label>Chunk-storlek</label>
              <select id="addPdfChunkSize">
                <option value="256">256 tokens</option>
                <option value="512" selected>512 tokens</option>
                <option value="1024">1024 tokens</option>
              </select>
            </div>
          </div>

          <div class="zone" id="addDropzone">
            <span class="material-icons" style="font-size: 48px; color: var(--on-surface-disabled);">cloud_upload</span>
            <p><strong>Släpp PDF här</strong></p>
            <p class="text-muted">eller</p>
            <label class="btn btn-outlined" for="addFile"><span class="material-icons">folder_open</span> Välj PDF</label>
            <input class="hidden" id="addFile" type="file" accept="application/pdf" />
          </div>
        </div>

        <div id="result" class="result hidden"></div>
        
        <div id="pdfResult" style="display:none; margin-top:20px">
          <div class="stats">
            <div class="stat-card"><div class="stat-label">Samling</div><div class="stat-value" id="pdfCollectionNameDisplay">-</div></div>
            <div class="stat-card"><div class="stat-label">Totalt chunkar</div><div class="stat-value" id="pdfRecordCount">-</div></div>
            <div class="stat-card"><div class="stat-label">Totalt vektorer</div><div class="stat-value" id="pdfVectorCount">-</div></div>
          </div>
          <div id="pdfListContainer" class="hidden">
            <h3><span class="material-icons">description</span> Indexerade PDFs</h3>
            <div id="pdfListDisplay" class="url-list"></div>
          </div>
        </div>
      </div>

      <!-- URL Fetch -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">Extrahera från URL</h2>
          <button class="btn btn-outlined" id="clearUrlBtn" style="text-transform: none;">
            <span class="material-icons">clear</span> Rensa
          </button>
        </div>
        <p class="text-muted">Hämta och indexera innehåll från en eller flera webbsidor.</p>
        
        <!-- Mode Selector -->
        <div class="mode-selector">
          <div class="mode-btn active" id="modeSingle">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">link</span>
            En URL
          </div>
          <div class="mode-btn" id="modeMultiple">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">link_off</span>
            Flera URLs
          </div>
          <div class="mode-btn" id="modeAddToExisting">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">add_link</span>
            Lägg till i befintlig
          </div>
        </div>

        <!-- Single URL Mode -->
        <div id="singleUrlMode">
          <div style="margin-bottom: 16px;">
            <label>Samlingens namn (valfritt)</label>
            <input id="urlCollectionName" type="text" placeholder="T.ex. 'Wikipedia AI' eller lämna tomt för automatiskt namn" />
          </div>
          
          <div class="input-group">
            <div style="flex: 1;"><label>Webbadress</label><input id="urlInput" type="url" placeholder="https://exempel.se/sida" /></div>
            <div style="width: 200px;"><label>Embedding Model</label>
              <select id="embedBackend">
                <option value="google">Google</option>
                <option value="openai">OpenAI</option>
                <option value="sbert">SBERT</option>
                <option value="ollama">Ollama</option>
              </select>
            </div>
            <button class="btn btn-raised" id="fetchBtn"><span class="material-icons">download</span> Hämta</button>
          </div>
        </div>

        <!-- Multiple URLs Mode -->
        <div id="multipleUrlsMode" class="hidden">
          <div style="margin-bottom: 16px;">
            <label>Samlingens namn (obligatoriskt)</label>
            <input id="multiUrlCollectionName" type="text" placeholder="T.ex. 'AI Research Articles'" />
          </div>

          <div style="margin-bottom: 16px;">
            <label>URLs (en per rad)</label>
            <textarea id="multiUrlInput" placeholder="https://exempel.se/sida1&#10;https://exempel.se/sida2&#10;https://exempel.se/sida3"></textarea>
            <p class="text-muted" style="margin-top: 4px;">Ange en URL per rad. Alla kommer att indexeras till samma samling.</p>
          </div>

          <div class="input-group">
            <div style="flex: 1;"><label>Embedding Model</label>
              <select id="multiEmbedBackend">
                <option value="google">Google</option>
                <option value="openai">OpenAI</option>
                <option value="sbert">SBERT</option>
                <option value="ollama">Ollama</option>
              </select>
            </div>
            <button class="btn btn-raised" id="multiFetchBtn"><span class="material-icons">download</span> Hämta alla</button>
          </div>

          <div id="multiProgress" style="display: none; margin-top: 16px;">
            <div style="background: #e0e0e0; border-radius: 4px; height: 8px; overflow: hidden;">
              <div id="multiProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p id="multiProgressText" class="text-muted" style="margin-top: 8px; text-align: center;">0 / 0</p>
          </div>
        </div>

        <!-- Add to Existing Mode -->
        <div id="addToExistingMode" class="hidden">
          <div style="margin-bottom: 16px;">
            <label>Välj befintlig samling</label>
            <select id="existingCollectionSelect">
              <option value="">-- Välj samling --</option>
            </select>
          </div>

          <div style="margin-bottom: 16px;">
            <label>URL att lägga till</label>
            <input id="addUrlInput" type="url" placeholder="https://exempel.se/ny-sida" />
          </div>

          <div class="input-group">
            <div style="flex: 1;"><label>Embedding Model</label>
              <select id="addEmbedBackend">
                <option value="google">Google</option>
                <option value="openai">OpenAI</option>
                <option value="sbert">SBERT</option>
                <option value="ollama">Ollama</option>
              </select>
            </div>
            <button class="btn btn-raised" id="addFetchBtn"><span class="material-icons">add</span> Lägg till</button>
          </div>
        </div>

        <div id="urlResult" style="display:none; margin-top:20px">
          <div class="stats">
            <div class="stat-card"><div class="stat-label">Samling</div><div class="stat-value" id="collectionName">-</div></div>
            <div class="stat-card"><div class="stat-label">Totalt chunkar</div><div class="stat-value" id="recordCount">-</div></div>
            <div class="stat-card"><div class="stat-label">Totalt vektorer</div><div class="stat-value" id="vectorCount">-</div></div>
          </div>
          <div id="urlListContainer" class="hidden">
            <h3><span class="material-icons">link</span> Indexerade URLs</h3>
            <div id="urlListDisplay" class="url-list"></div>
          </div>
        </div>
      </div>

      <!-- Search -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">Semantisk Sökning</h2>
          <button class="btn btn-outlined" id="clearSearchBtn" style="text-transform: none;">
            <span class="material-icons">clear</span> Rensa
          </button>
        </div>
        <p class="text-muted">Sök i indexerat innehåll med naturligt språk.</p>
        <div class="input-group">
          <div style="flex: 1;"><label>Välj Samling</label><select id="searchCollection"><option value="">-- Välj --</option></select></div>
          <button class="btn btn-outlined" id="refreshCollections"><span class="material-icons">refresh</span> Uppdatera</button>
        </div>
        <div class="input-group" style="margin-top: 12px;">
          <div style="flex: 1;"><label>Sökfråga</label><input id="searchQuery" type="text" placeholder="Vad letar du efter?" /></div>
          <div style="width: 120px;"><label>Antal</label>
            <select id="searchK"><option value="3">Top 3</option><option value="5" selected>Top 5</option><option value="10">Top 10</option></select>
          </div>
          <button class="btn btn-raised" id="searchBtn"><span class="material-icons">search</span> Sök</button>
        </div>
        <div id="searchResults" style="margin-top: 24px;"></div>
      </div>

      <!-- ASK AI -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">Fråga AI</h2>
          <button class="btn btn-outlined" id="clearAskBtn" style="text-transform: none;">
            <span class="material-icons">clear</span> Rensa
          </button>
        </div>
        <p class="text-muted">Ställ frågor på naturligt språk. AI:n söker i dina dokument och formulerar ett svar.</p>
        <div class="input-group">
          <div style="flex: 1;"><label>Välj Samling</label><select id="askCollection"><option value="">-- Välj --</option></select></div>
          <div style="width: 180px;"><label>LLM-modell</label>
            <select id="llmBackend">
              <option value="google">Google Gemini</option>
              <option value="openai">OpenAI GPT</option>
              <option value="ollama">Ollama (Lokal)</option>
            </select>
          </div>
          <div style="width: 120px;"><label>Antal källor</label>
            <select id="askK"><option value="3">Top 3</option><option value="5" selected>Top 5</option><option value="10">Top 10</option></select>
          </div>
        </div>
        <div class="input-group" style="margin-top: 12px;">
          <div style="flex: 1;"><label>Din fråga</label><input id="askQuery" type="text" placeholder="Ställ en fråga om dokumentet..." /></div>
          <button class="btn btn-raised" id="askBtn"><span class="material-icons">send</span> Fråga</button>
        </div>
        <div id="askLoading" style="display: none; margin-top: 24px; text-align: center; padding: 32px;">
          <div class="spinner" style="width: 32px; height: 32px; border-width: 3px;"></div>
          <p style="margin-top: 16px; color: var(--on-surface-medium);">Söker i dokument och genererar svar...</p>
        </div>
        <div id="askAnswer" style="display: none; margin-top: 24px;">
          <div class="ai-answer-box">
            <div style="display: flex; gap: 12px;">
              <span class="material-icons" style="color: var(--secondary); font-size: 28px;">smart_toy</span>
              <div style="flex: 1;">
                <h4 style="margin: 0 0 12px; color: var(--secondary);">Svar från AI</h4>
                <div id="askAnswerText" class="ai-answer-text"></div>
              </div>
            </div>
          </div>
          <details style="margin-top: 16px;">
            <summary style="cursor: pointer; font-weight: 500; color: var(--primary);"><span class="material-icons" style="vertical-align: middle;">source</span> Visa källor som användes</summary>
            <div id="askSources" style="margin-top: 12px;"></div>
          </details>
        </div>
      </div>
    </div>

    <script>
      let currentMode = 'single';
      let currentPdfMode = 'single';

      // URL Mode switching
      document.getElementById('modeSingle').addEventListener('click', () => switchMode('single'));
      document.getElementById('modeMultiple').addEventListener('click', () => switchMode('multiple'));
      document.getElementById('modeAddToExisting').addEventListener('click', () => switchMode('add'));

      // PDF Mode switching
      document.getElementById('pdfModeSingle').addEventListener('click', () => switchPdfMode('single'));
      document.getElementById('pdfModeMultiple').addEventListener('click', () => switchPdfMode('multiple'));
      document.getElementById('pdfModeAddToExisting').addEventListener('click', () => switchPdfMode('add'));

      function switchMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('singleUrlMode').classList.add('hidden');
        document.getElementById('multipleUrlsMode').classList.add('hidden');
        document.getElementById('addToExistingMode').classList.add('hidden');

        if (mode === 'single') {
          document.getElementById('modeSingle').classList.add('active');
          document.getElementById('singleUrlMode').classList.remove('hidden');
        } else if (mode === 'multiple') {
          document.getElementById('modeMultiple').classList.add('active');
          document.getElementById('multipleUrlsMode').classList.remove('hidden');
        } else if (mode === 'add') {
          document.getElementById('modeAddToExisting').classList.add('active');
          document.getElementById('addToExistingMode').classList.remove('hidden');
          refreshExistingCollections();
        }
      }

      function switchPdfMode(mode) {
        currentPdfMode = mode;
        // Remove active from all PDF mode buttons
        document.getElementById('pdfModeSingle').classList.remove('active');
        document.getElementById('pdfModeMultiple').classList.remove('active');
        document.getElementById('pdfModeAddToExisting').classList.remove('active');
        
        // Hide all PDF modes
        document.getElementById('singlePdfMode').classList.add('hidden');
        document.getElementById('multiplePdfsMode').classList.add('hidden');
        document.getElementById('addPdfToExistingMode').classList.add('hidden');

        if (mode === 'single') {
          document.getElementById('pdfModeSingle').classList.add('active');
          document.getElementById('singlePdfMode').classList.remove('hidden');
        } else if (mode === 'multiple') {
          document.getElementById('pdfModeMultiple').classList.add('active');
          document.getElementById('multiplePdfsMode').classList.remove('hidden');
        } else if (mode === 'add') {
          document.getElementById('pdfModeAddToExisting').classList.add('active');
          document.getElementById('addPdfToExistingMode').classList.remove('hidden');
          refreshExistingPdfCollections();
        }
      }

      // PDF Upload - Single Mode
      const drop = document.getElementById('dropzone');
      const fileInput = document.getElementById('file');
      const result = document.getElementById('result');
      const pdfCollectionNameInput = document.getElementById('pdfCollectionName');

      function show(html) { result.classList.remove('hidden'); result.innerHTML = html; }

      async function handleFile(file, collectionName = null) {
        if (!file || !file.name.toLowerCase().endsWith('.pdf')) {
          show('<p style="color:var(--error);">Välj en giltig PDF-fil.</p>');
          return;
        }
        show('<p><span class="spinner"></span> Laddar upp: <code>' + file.name + '</code></p>');
        try {
          const form = new FormData();
          form.append('file', file);
          const backend = document.getElementById('pdfEmbedBackend').value;
          const chunk = document.getElementById('pdfChunkSize').value;
          const colName = collectionName || pdfCollectionNameInput.value.trim();
          
          let url = '/api/upload_pdf?embed_backend=' + backend + '&max_tokens_per_chunk=' + chunk;
          if (colName) {
            url += '&collection_name=' + encodeURIComponent(colName);
          }
          
          const res = await fetch(url, { method: 'POST', body: form });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.detail || 'Fel');
          
          displayPdfResults(data);
          show('<p style="color:var(--secondary);"><span class="material-icons" style="vertical-align:middle;">check_circle</span> Klart! Samling: <strong>' + data.collection_name + '</strong> (' + data.record_count + ' chunkar)</p>');
          pdfCollectionNameInput.value = '';
          refreshAllCollections();
          return data;
        } catch (e) { 
          show('<p style="color:var(--error);">Fel: ' + e.message + '</p>'); 
          throw e;
        }
      }

      ['dragenter','dragover'].forEach(e => drop.addEventListener(e, ev => { ev.preventDefault(); drop.classList.add('dragover'); }));
      ['dragleave','drop'].forEach(e => drop.addEventListener(e, ev => { ev.preventDefault(); drop.classList.remove('dragover'); }));
      drop.addEventListener('drop', e => handleFile(e.dataTransfer.files?.[0]));
      fileInput.addEventListener('change', e => handleFile(e.target.files?.[0]));

      // PDF Upload - Multiple Mode
      const multiDropzone = document.getElementById('multiDropzone');
      const multiFileInput = document.getElementById('multiFile');

      async function handleMultiplePdfs(files) {
        const collectionName = document.getElementById('multiPdfCollectionName').value.trim();
        if (!collectionName) { alert('Ange ett samlingens namn.'); return; }
        if (!files || files.length === 0) { alert('Välj minst en PDF-fil.'); return; }

        const backend = document.getElementById('multiPdfEmbedBackend').value;
        const chunk = document.getElementById('multiPdfChunkSize').value;
        const progress = document.getElementById('multiPdfProgress');
        const progressBar = document.getElementById('multiPdfProgressBar');
        const progressText = document.getElementById('multiPdfProgressText');

        progress.style.display = 'block';
        let completed = 0;
        let lastData = null;

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (!file.name.toLowerCase().endsWith('.pdf')) continue;
          
          try {
            progressText.textContent = `${completed} / ${files.length} - Laddar upp ${file.name}`;
            
            const form = new FormData();
            form.append('file', file);
            let url = '/api/upload_pdf?embed_backend=' + backend + '&max_tokens_per_chunk=' + chunk + '&collection_name=' + encodeURIComponent(collectionName);
            
            const res = await fetch(url, { method: 'POST', body: form });
            const data = await res.json();
            if (!res.ok) throw new Error(data?.detail || 'Fel');
            
            lastData = data;
            completed++;
            progressBar.style.width = `${(completed / files.length) * 100}%`;
            progressText.textContent = `${completed} / ${files.length}`;
          } catch (e) {
            console.error(`Fel vid ${file.name}:`, e);
          }
        }

        progressText.textContent = `Klart! ${completed} / ${files.length} PDFs indexerade`;
        
        if (lastData) {
          displayPdfResults(lastData);
        }
        
        refreshAllCollections();
        setTimeout(() => { progress.style.display = 'none'; progressBar.style.width = '0%'; }, 3000);
      }

      ['dragenter','dragover'].forEach(e => multiDropzone.addEventListener(e, ev => { ev.preventDefault(); multiDropzone.classList.add('dragover'); }));
      ['dragleave','drop'].forEach(e => multiDropzone.addEventListener(e, ev => { ev.preventDefault(); multiDropzone.classList.remove('dragover'); }));
      multiDropzone.addEventListener('drop', e => handleMultiplePdfs(e.dataTransfer.files));
      multiFileInput.addEventListener('change', e => handleMultiplePdfs(e.target.files));

      // PDF Upload - Add to Existing Mode
      const addDropzone = document.getElementById('addDropzone');
      const addFileInput = document.getElementById('addFile');

      async function handleAddPdf(file) {
        const collection = document.getElementById('existingPdfCollectionSelect').value;
        if (!collection) { alert('Välj en samling.'); return; }
        if (!file || !file.name.toLowerCase().endsWith('.pdf')) {
          alert('Välj en giltig PDF-fil.');
          return;
        }

        const backend = document.getElementById('addPdfEmbedBackend').value;
        const chunk = document.getElementById('addPdfChunkSize').value;

        show('<p><span class="spinner"></span> Lägger till: <code>' + file.name + '</code></p>');
        
        try {
          const form = new FormData();
          form.append('file', file);
          let url = '/api/upload_pdf?embed_backend=' + backend + '&max_tokens_per_chunk=' + chunk + '&collection_name=' + encodeURIComponent(collection);
          
          const res = await fetch(url, { method: 'POST', body: form });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.detail || 'Fel');
          
          displayPdfResults(data);
          show('<p style="color:var(--secondary);"><span class="material-icons" style="vertical-align:middle;">check_circle</span> PDF tillagd till samlingen! (' + data.record_count + ' nya chunkar)</p>');
          refreshAllCollections();
          alert('PDF tillagd till samlingen!');
        } catch (e) {
          show('<p style="color:var(--error);">Fel: ' + e.message + '</p>');
        }
      }

      ['dragenter','dragover'].forEach(e => addDropzone.addEventListener(e, ev => { ev.preventDefault(); addDropzone.classList.add('dragover'); }));
      ['dragleave','drop'].forEach(e => addDropzone.addEventListener(e, ev => { ev.preventDefault(); addDropzone.classList.remove('dragover'); }));
      addDropzone.addEventListener('drop', e => handleAddPdf(e.dataTransfer.files?.[0]));
      addFileInput.addEventListener('change', e => handleAddPdf(e.target.files?.[0]));

      function displayPdfResults(data) {
        document.getElementById('pdfCollectionNameDisplay').textContent = data.collection_name;
        document.getElementById('pdfRecordCount').textContent = data.record_count || data.total_records || 0;
        document.getElementById('pdfVectorCount').textContent = data.vector_store?.stats?.total_vectors || data.total_vectors || 0;
        document.getElementById('pdfResult').style.display = 'block';

        if (data.indexed_pdfs && data.indexed_pdfs.length > 0) {
          const pdfListContainer = document.getElementById('pdfListContainer');
          const pdfListDisplay = document.getElementById('pdfListDisplay');
          pdfListContainer.classList.remove('hidden');
          pdfListDisplay.innerHTML = data.indexed_pdfs.map(p => 
            `<div class="url-item"><span class="material-icons" style="font-size: 16px; color: var(--secondary);">description</span><span class="url-item-text">${p}</span></div>`
          ).join('');
        }
      }

      async function refreshExistingPdfCollections() {
        try {
          const res = await fetch('/api/collections');
          const data = await res.json();
          const sel = document.getElementById('existingPdfCollectionSelect');
          sel.innerHTML = '<option value="">-- Välj samling --</option>';
          data.collections.forEach(c => {
            const o = document.createElement('option');
            o.value = c.name;
            o.textContent = c.name;
            sel.appendChild(o);
          });
        } catch (e) { console.error(e); }
      }

      // Single URL
      const urlEls = {
        input: document.getElementById('urlInput'),
        backend: document.getElementById('embedBackend'),
        btn: document.getElementById('fetchBtn'),
        panel: document.getElementById('urlResult'),
        collection: document.getElementById('collectionName'),
        records: document.getElementById('recordCount'),
        vectors: document.getElementById('vectorCount'),
        collectionNameInput: document.getElementById('urlCollectionName'),
      };

      urlEls.btn.addEventListener('click', async () => {
        const url = urlEls.input.value.trim();
        if (!url) { alert('Ange en URL.'); return; }
        const collectionName = urlEls.collectionNameInput.value.trim();
        
        urlEls.btn.disabled = true;
        urlEls.btn.innerHTML = '<span class="spinner"></span> Hämtar...';
        try {
          const payload = { 
            url, 
            embed_backend: urlEls.backend.value 
          };
          if (collectionName) {
            payload.collection_name = collectionName;
          }
          
          const res = await fetch('/api/fetch_url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.detail || 'Fel');
          displayUrlResults(data);
          urlEls.collectionNameInput.value = '';
          refreshAllCollections();
        } catch (e) { alert('Fel: ' + e.message); }
        urlEls.btn.disabled = false;
        urlEls.btn.innerHTML = '<span class="material-icons">download</span> Hämta';
      });

      // Multiple URLs
      document.getElementById('multiFetchBtn').addEventListener('click', async () => {
        const urls = document.getElementById('multiUrlInput').value.trim().split('\n').filter(u => u.trim());
        const collectionName = document.getElementById('multiUrlCollectionName').value.trim();
        const backend = document.getElementById('multiEmbedBackend').value;

        if (!collectionName) { alert('Ange ett samlingens namn.'); return; }
        if (urls.length === 0) { alert('Ange minst en URL.'); return; }

        const btn = document.getElementById('multiFetchBtn');
        const progress = document.getElementById('multiProgress');
        const progressBar = document.getElementById('multiProgressBar');
        const progressText = document.getElementById('multiProgressText');

        btn.disabled = true;
        progress.style.display = 'block';

        let completed = 0;
        for (const url of urls) {
          if (!url.trim()) continue;
          try {
            progressText.textContent = `${completed} / ${urls.length} - Hämtar ${url}`;
            const res = await fetch('/api/fetch_url', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url: url.trim(), collection_name: collectionName, embed_backend: backend })
            });
            if (!res.ok) throw new Error(await res.text());
            completed++;
            progressBar.style.width = `${(completed / urls.length) * 100}%`;
            progressText.textContent = `${completed} / ${urls.length}`;
          } catch (e) {
            console.error(`Fel vid ${url}:`, e);
          }
        }

        progressText.textContent = `Klart! ${completed} / ${urls.length} URLs indexerade`;
        btn.disabled = false;
        
        // Get final stats
        try {
          const statsRes = await fetch('/api/collection_info/' + encodeURIComponent(collectionName));
          const stats = await statsRes.json();
          displayUrlResults(stats);
        } catch (e) {}

        refreshAllCollections();
        setTimeout(() => { progress.style.display = 'none'; progressBar.style.width = '0%'; }, 3000);
      });

      // Add to existing
      document.getElementById('addFetchBtn').addEventListener('click', async () => {
        const url = document.getElementById('addUrlInput').value.trim();
        const collection = document.getElementById('existingCollectionSelect').value;
        const backend = document.getElementById('addEmbedBackend').value;

        if (!url) { alert('Ange en URL.'); return; }
        if (!collection) { alert('Välj en samling.'); return; }

        const btn = document.getElementById('addFetchBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Lägger till...';

        try {
          const res = await fetch('/api/fetch_url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url, collection_name: collection, embed_backend: backend })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.detail || 'Fel');
          displayUrlResults(data);
          document.getElementById('addUrlInput').value = '';
          refreshAllCollections();
          alert('URL tillagd till samlingen!');
        } catch (e) { alert('Fel: ' + e.message); }

        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons">add</span> Lägg till';
      });

      function displayUrlResults(data) {
        urlEls.collection.textContent = data.collection_name;
        urlEls.records.textContent = data.record_count || data.total_records || 0;
        urlEls.vectors.textContent = data.vector_store?.stats?.total_vectors || data.total_vectors || 0;
        urlEls.panel.style.display = 'block';

        if (data.indexed_urls && data.indexed_urls.length > 0) {
          const urlListContainer = document.getElementById('urlListContainer');
          const urlListDisplay = document.getElementById('urlListDisplay');
          urlListContainer.classList.remove('hidden');
          urlListDisplay.innerHTML = data.indexed_urls.map(u => 
            `<div class="url-item"><span class="material-icons" style="font-size: 16px; color: var(--secondary);">link</span><span class="url-item-text">${u}</span></div>`
          ).join('');
        }
      }

      async function refreshExistingCollections() {
        try {
          const res = await fetch('/api/collections');
          const data = await res.json();
          const sel = document.getElementById('existingCollectionSelect');
          sel.innerHTML = '<option value="">-- Välj samling --</option>';
          data.collections.forEach(c => {
            const o = document.createElement('option');
            o.value = c.name;
            o.textContent = c.name;
            sel.appendChild(o);
          });
        } catch (e) { console.error(e); }
      }

      const searchEls = {
        collection: document.getElementById('searchCollection'),
        query: document.getElementById('searchQuery'),
        k: document.getElementById('searchK'),
        btn: document.getElementById('searchBtn'),
        results: document.getElementById('searchResults'),
        refresh: document.getElementById('refreshCollections'),
      };

      const askEls = {
        collection: document.getElementById('askCollection'),
        query: document.getElementById('askQuery'),
        k: document.getElementById('askK'),
        llm: document.getElementById('llmBackend'),
        btn: document.getElementById('askBtn'),
        answer: document.getElementById('askAnswer'),
        answerText: document.getElementById('askAnswerText'),
        sources: document.getElementById('askSources'),
        loading: document.getElementById('askLoading'),
      };

      async function refreshAllCollections() {
        try {
          const res = await fetch('/api/collections');
          const data = await res.json();
          [searchEls.collection, askEls.collection].forEach(sel => {
            const val = sel.value;
            sel.innerHTML = '<option value="">-- Välj samling --</option>';
            data.collections.forEach(c => {
              const o = document.createElement('option');
              o.value = c.name;
              o.textContent = c.name + (c.loaded ? ' ✓' : '');
              sel.appendChild(o);
            });
            if (val) sel.value = val;
          });
        } catch (e) { console.error(e); }
      }

      searchEls.btn.addEventListener('click', async () => {
        const col = searchEls.collection.value, q = searchEls.query.value.trim(), k = searchEls.k.value;
        if (!col) { alert('Välj en samling.'); return; }
        if (!q) { alert('Ange sökfråga.'); return; }
        searchEls.results.innerHTML = '<p><span class="spinner"></span> Söker...</p>';
        try {
          const res = await fetch('/api/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ collection: col, query: q, k: parseInt(k) })
          });
          const data = await res.json();
          if (!data.results?.length) {
            searchEls.results.innerHTML = '<div class="empty-state"><span class="material-icons">search_off</span><p>Inga resultat.</p></div>';
            return;
          }
          let html = '<h3>' + data.results_count + ' resultat</h3>';
          data.results.forEach(r => {
            html += '<div class="search-result"><div class="search-result-header"><h4 class="search-result-title">' + (r.heading || 'Utan titel') + '</h4><span class="search-result-score">' + r.score + '</span></div><div class="search-result-text">' + r.markdown + '</div></div>';
          });
          searchEls.results.innerHTML = html;
        } catch (e) { searchEls.results.innerHTML = '<p style="color:var(--error);">Fel: ' + e.message + '</p>'; }
      });

      searchEls.refresh.addEventListener('click', refreshAllCollections);
      searchEls.query.addEventListener('keypress', e => { if (e.key === 'Enter') searchEls.btn.click(); });

      askEls.btn.addEventListener('click', async () => {
        const col = askEls.collection.value, q = askEls.query.value.trim(), k = askEls.k.value, llm = askEls.llm.value;
        if (!col) { alert('Välj en samling.'); return; }
        if (!q) { alert('Skriv en fråga.'); return; }
        askEls.answer.style.display = 'none';
        askEls.loading.style.display = 'block';
        askEls.btn.disabled = true;
        try {
          const res = await fetch('/api/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ collection: col, query: q, k: parseInt(k), llm_backend: llm })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.detail || 'Fel');
          askEls.answerText.textContent = data.answer;
          let srcHtml = '';
          if (data.sources?.length) {
            data.sources.forEach(s => {
              srcHtml += '<div class="search-result"><div class="search-result-header"><h4 class="search-result-title">' + (s.heading || 'Källa ' + s.rank) + '</h4><span class="search-result-score">' + s.score + '</span></div><div class="search-result-text">' + s.preview + '</div></div>';
            });
          } else {
            srcHtml = '<p class="text-muted">Inga källor.</p>';
          }
          askEls.sources.innerHTML = srcHtml;
          askEls.loading.style.display = 'none';
          askEls.answer.style.display = 'block';
        } catch (e) {
          askEls.loading.style.display = 'none';
          askEls.answer.style.display = 'block';
          askEls.answerText.textContent = 'Fel: ' + e.message;
          askEls.sources.innerHTML = '';
        }
        askEls.btn.disabled = false;
      });

      askEls.query.addEventListener('keypress', e => { if (e.key === 'Enter') askEls.btn.click(); });

      // Clear buttons functionality
      document.getElementById('clearPdfBtn').addEventListener('click', () => {
        // Single mode
        pdfCollectionNameInput.value = '';
        fileInput.value = '';
        
        // Multiple mode
        document.getElementById('multiPdfCollectionName').value = '';
        multiFileInput.value = '';
        document.getElementById('multiPdfProgress').style.display = 'none';
        document.getElementById('multiPdfProgressBar').style.width = '0%';
        document.getElementById('multiPdfProgressText').textContent = '0 / 0';
        
        // Add to existing mode
        addFileInput.value = '';
        document.getElementById('existingPdfCollectionSelect').value = '';
        
        // Hide results
        result.classList.add('hidden');
        result.innerHTML = '';
        document.getElementById('pdfResult').style.display = 'none';
        document.getElementById('pdfListContainer').classList.add('hidden');
        document.getElementById('pdfListDisplay').innerHTML = '';
      });

      document.getElementById('clearUrlBtn').addEventListener('click', () => {
        // Single mode
        urlEls.input.value = '';
        urlEls.collectionNameInput.value = '';
        
        // Multiple mode
        document.getElementById('multiUrlInput').value = '';
        document.getElementById('multiUrlCollectionName').value = '';
        document.getElementById('multiProgress').style.display = 'none';
        document.getElementById('multiProgressBar').style.width = '0%';
        document.getElementById('multiProgressText').textContent = '0 / 0';
        
        // Add to existing mode
        document.getElementById('addUrlInput').value = '';
        document.getElementById('existingCollectionSelect').value = '';
        
        // Hide results
        urlEls.panel.style.display = 'none';
        document.getElementById('urlListContainer').classList.add('hidden');
        document.getElementById('urlListDisplay').innerHTML = '';
      });

      document.getElementById('clearSearchBtn').addEventListener('click', () => {
        searchEls.collection.value = '';
        searchEls.query.value = '';
        searchEls.results.innerHTML = '';
      });

      document.getElementById('clearAskBtn').addEventListener('click', () => {
        askEls.collection.value = '';
        askEls.query.value = '';
        askEls.answer.style.display = 'none';
        askEls.loading.style.display = 'none';
        askEls.answerText.textContent = '';
        askEls.sources.innerHTML = '';
      });

      refreshAllCollections();
    </script>
  </body>
</html>