<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RAG Search System</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
      :root { 
        font-family: 'Roboto', sans-serif;
        --primary: #1976d2;
        --primary-dark: #1565c0;
        --primary-light: #42a5f5;
        --secondary: #388e3c;
        --error: #d32f2f;
        --background: #fafafa;
        --surface: #ffffff;
        --on-primary: #ffffff;
        --on-surface: rgba(0, 0, 0, 0.87);
        --on-surface-medium: rgba(0, 0, 0, 0.60);
        --on-surface-disabled: rgba(0, 0, 0, 0.38);
        --divider: rgba(0, 0, 0, 0.12);
      }
      * { box-sizing: border-box; }
      body { margin: 0; background: var(--background); color: var(--on-surface); line-height: 1.5; }
      .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
      .app-bar { background: var(--primary); color: var(--on-primary); padding: 16px 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); margin-bottom: 24px; }
      .app-bar h1 { margin: 0; font-size: 24px; font-weight: 400; }
      .app-bar p { margin: 8px 0 0 0; opacity: 0.9; font-size: 14px; }
      h2 { font-size: 20px; font-weight: 500; margin: 0 0 16px; display: flex; align-items: center; gap: 8px; }
      h3 { font-size: 16px; font-weight: 500; margin: 24px 0 12px; display: flex; align-items: center; gap: 8px; }
      .card { background: var(--surface); border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; }
      .zone { border: 2px dashed var(--divider); border-radius: 4px; padding: 48px 32px; text-align: center; transition: all 0.2s; background: #fafafa; margin-top: 16px; }
      .zone.dragover { border-color: var(--primary); background: #e3f2fd; }
      .btn { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-family: 'Roboto', sans-serif; font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s; background: transparent; color: var(--primary); }
      .btn:hover { background: rgba(25, 118, 210, 0.08); }
      .btn-raised { background: var(--primary); color: var(--on-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
      .btn-raised:hover { background: var(--primary-dark); }
      .btn-outlined { border: 1px solid var(--primary); }
      .btn:disabled { background: var(--on-surface-disabled); color: rgba(0,0,0,0.26); cursor: not-allowed; }
      .hidden { display: none !important; }
      .result { margin-top: 16px; padding: 16px; background: #e8f5e9; border-left: 4px solid var(--secondary); border-radius: 4px; }
      code { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 3px; font-size: 13px; }
      input[type="text"], input[type="url"], select, textarea { width: 100%; padding: 12px 16px; border: 1px solid var(--divider); border-bottom: 2px solid var(--divider); border-radius: 4px 4px 0 0; font-size: 16px; font-family: 'Roboto', sans-serif; }
      textarea { min-height: 120px; resize: vertical; line-height: 1.5; }
      input:focus, select:focus, textarea:focus { outline: none; border-bottom-color: var(--primary); }
      .input-group { display: flex; gap: 12px; align-items: flex-end; margin-top: 16px; }
      .input-group input, .input-group select { flex: 1; }
      .search-result { background: var(--surface); border-radius: 4px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
      .search-result:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.16); }
      .search-result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
      .search-result-title { font-weight: 500; font-size: 16px; margin: 0 0 4px 0; }
      .search-result-score { background: #e3f2fd; color: var(--primary); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
      .search-result-text { color: var(--on-surface-medium); font-size: 14px; line-height: 1.6; }
      .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0; }
      .stat-card { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 4px; }
      .stat-label { font-size: 12px; color: var(--on-surface-medium); text-transform: uppercase; font-weight: 500; }
      .stat-value { font-size: 32px; font-weight: 300; color: var(--primary); margin-top: 8px; }
      ul { padding-left: 20px; }
      li { margin: 8px 0; }
      a { color: var(--primary); text-decoration: none; }
      a:hover { text-decoration: underline; }
      .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .info-box { margin-top: 16px; padding: 16px; background: #e3f2fd; border-left: 4px solid var(--primary); border-radius: 4px; display: flex; gap: 12px; }
      .empty-state { text-align: center; padding: 48px 24px; color: var(--on-surface-medium); }
      .empty-state .material-icons { font-size: 64px; color: var(--on-surface-disabled); margin-bottom: 16px; }
      label { display: block; font-size: 12px; color: var(--on-surface-medium); margin-bottom: 4px; font-weight: 500; }
      .text-muted { color: var(--on-surface-medium); font-size: 13px; }
      .ai-answer-box { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; padding: 20px; }
      .ai-answer-text { white-space: pre-wrap; line-height: 1.7; }
      .mode-selector { display: flex; gap: 8px; margin-bottom: 16px; }
      .mode-btn { flex: 1; padding: 12px; border: 2px solid var(--divider); border-radius: 4px; background: white; cursor: pointer; text-align: center; font-weight: 500; transition: all 0.2s; }
      .mode-btn:hover { background: #f5f5f5; }
      .mode-btn.active { border-color: var(--primary); background: #e3f2fd; color: var(--primary); }
      .url-list { background: #f5f5f5; border-radius: 4px; padding: 12px; margin-top: 12px; max-height: 200px; overflow-y: auto; }
      .url-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px; margin-bottom: 8px; font-size: 13px; }
      .url-item:last-child { margin-bottom: 0; }
      .url-item-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .url-item-remove { color: var(--error); cursor: pointer; padding: 4px; }
      .url-item-remove:hover { background: rgba(211, 47, 47, 0.1); border-radius: 50%; }
    </style>
  </head>
  <body>
    <div class="app-bar">
      <h1>RAG Search System</h1>
      <p>Ladda upp PDF-filer eller extrahera text från webbsidor, och sök sedan semantiskt med AI i dina samlingar.</p>
    </div>

    <div class="wrap">
      <!-- PDF Upload -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">Extrahera från PDF</h2>
          <button class="btn btn-outlined" id="clearPdfBtn" style="text-transform: none;">
            <span class="material-icons">clear</span> Rensa
          </button>
        </div>
        <p class="text-muted">Ladda upp en eller flera PDFs. Stöder både nya samlingar och tillägg till befintliga.</p>
        
        <!-- Mode Selector for PDF -->
        <div class="mode-selector">
          <div class="mode-btn active" id="pdfModeNew">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">add_circle</span>
            Ny samling
          </div>
          <div class="mode-btn" id="pdfModeAdd">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">library_add</span>
            Lägg till i befintlig
          </div>
        </div>

        <!-- New Collection Mode -->
        <div id="pdfNewMode">
          <div style="margin-bottom: 16px;">
            <label>Samlingens namn (valfritt)</label>
            <input id="pdfCollectionName" type="text" placeholder="Exempel: 'Årsredovisning 2024'" />
            <p class="text-muted" style="margin-top: 4px;">Om du lämnar tomt skapas namnet automatiskt från första filen</p>
          </div>
          
          <div class="input-group" style="margin-bottom: 16px;">
            <div style="flex: 1;"><label>Embedding Model</label>
              <select id="pdfEmbedBackend">
                <option value="google">Google Gemini (Standard)</option>
                <option value="cohere">Cohere v3 ⭐ Robust mot brus</option>
                <option value="bge">BGE-M3 ⭐ State-of-the-art OSS</option>
                <option value="e5">E5 ⭐ Multilingual, bra för svenska</option>
                <option value="openai">OpenAI</option>
                <option value="sbert">Sentence-BERT (Enkel)</option>
                <option value="ollama">Ollama (Lokal)</option>
              </select>
            </div>
            <div style="flex: 1;"><label>Chunk-storlek</label>
              <select id="pdfChunkSize">
                <option value="256">256 tokens</option>
                <option value="512" selected>512 tokens</option>
                <option value="1024">1024 tokens</option>
              </select>
            </div>
          </div>

          <div id="pdfDropzone" class="zone">
            <span class="material-icons" style="font-size: 48px; color: var(--on-surface-disabled);">cloud_upload</span>
            <p><strong>Släpp en eller flera PDFs här</strong></p>
            <p class="text-muted">eller</p>
            <label class="btn btn-outlined" for="pdfFile"><span class="material-icons">folder_open</span> Välj PDF(er)</label>
            <input class="hidden" id="pdfFile" type="file" accept="application/pdf" multiple />
          </div>
        </div>

        <!-- Add to Existing Mode -->
        <div id="pdfAddMode" class="hidden">
          <div style="margin-bottom: 16px;">
            <label>Välj befintlig samling</label>
            <select id="existingPdfCollectionSelect">
              <option value="">-- Välj samling --</option>
            </select>
          </div>

          <div class="input-group" style="margin-bottom: 16px;">
            <div style="flex: 1;"><label>Embedding Model</label>
              <select id="addPdfEmbedBackend">
                <option value="google">Google Gemini (Standard)</option>
                <option value="cohere">Cohere v3 ⭐ Robust mot brus</option>
                <option value="bge">BGE-M3 ⭐ State-of-the-art OSS</option>
                <option value="e5">E5 ⭐ Multilingual, bra för svenska</option>
                <option value="openai">OpenAI</option>
                <option value="sbert">Sentence-BERT (Enkel)</option>
                <option value="ollama">Ollama (Lokal)</option>
              </select>
            </div>
            <div style="flex: 1;"><label>Chunk-storlek</label>
              <select id="addPdfChunkSize">
                <option value="256">256 tokens</option>
                <option value="512" selected>512 tokens</option>
                <option value="1024">1024 tokens</option>
              </select>
            </div>
          </div>

          <div class="zone" id="addPdfDropzone">
            <span class="material-icons" style="font-size: 48px; color: var(--on-surface-disabled);">cloud_upload</span>
            <p><strong>Släpp en eller flera PDFs här</strong></p>
            <p class="text-muted">eller</p>
            <label class="btn btn-outlined" for="addPdfFile"><span class="material-icons">folder_open</span> Välj PDF(er)</label>
            <input class="hidden" id="addPdfFile" type="file" accept="application/pdf" multiple />
          </div>
        </div>

        <div id="pdfProgress" style="display: none; margin-top: 16px;">
          <div style="background: #e0e0e0; border-radius: 4px; height: 8px; overflow: hidden;">
            <div id="pdfProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
          </div>
          <p id="pdfProgressText" class="text-muted" style="margin-top: 8px; text-align: center;">0 / 0</p>
        </div>

        <div id="pdfResult" style="display:none; margin-top:20px">
          <div class="stats">
            <div class="stat-card"><div class="stat-label">Samling</div><div class="stat-value" id="pdfCollectionNameDisplay">-</div></div>
            <div class="stat-card"><div class="stat-label">Totalt chunkar</div><div class="stat-value" id="pdfRecordCount">-</div></div>
            <div class="stat-card"><div class="stat-label">Totalt vektorer</div><div class="stat-value" id="pdfVectorCount">-</div></div>
          </div>
          <div id="pdfListContainer" class="hidden">
            <h3><span class="material-icons">description</span> Indexerade PDFs</h3>
            <div id="pdfListDisplay" class="url-list"></div>
          </div>
        </div>
      </div>

      <!-- URL Fetch -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">Extrahera från URL</h2>
          <button class="btn btn-outlined" id="clearUrlBtn" style="text-transform: none;">
            <span class="material-icons">clear</span> Rensa
          </button>
        </div>
        <p class="text-muted">Hämta och indexera innehåll från en eller flera webbsidor.</p>
        
        <!-- Mode Selector -->
        <div class="mode-selector">
          <div class="mode-btn active" id="urlModeNew">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">add_circle</span>
            Ny samling
          </div>
          <div class="mode-btn" id="urlModeAdd">
            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">library_add</span>
            Lägg till i befintlig
          </div>
        </div>

        <!-- New Collection Mode -->
        <div id="urlNewMode">
          <div style="margin-bottom: 16px;">
            <label>Samlingens namn (valfritt)</label>
            <input id="urlCollectionName" type="text" placeholder="Exempel: 'Semester 2026'" />
            <p class="text-muted" style="margin-top: 4px;">Om du lämnar tomt skapas namnet automatiskt från första URL:en</p>
          </div>

          <div style="margin-bottom: 16px;">
            <label>URLs (en per rad)</label>
            <textarea id="urlInput" placeholder="https://exempel.se/sida1&#10;https://exempel.se/sida2&#10;https://exempel.se/sida3

Kan också ange bara en URL för en enda sida"></textarea>
            <p class="text-muted" style="margin-top: 4px;">Ange en eller flera URLs, en per rad. Alla kommer att indexeras till samma samling.</p>
          </div>

          <div class="input-group">
            <div style="flex: 1;"><label>Embedding Model</label>
              <select id="urlEmbedBackend">
                <option value="google">Google Gemini</option>
                <option value="cohere">Cohere v3 ⭐ Robust mot brus</option>
                <option value="bge">BGE-M3 ⭐ State-of-the-art OSS</option>
                <option value="e5">E5 ⭐ Multilingual, bra för svenska</option>
                <option value="openai">OpenAI</option>
                <option value="sbert">SBERT</option>
                <option value="ollama">Ollama</option>
              </select>
            </div>
            <button class="btn btn-raised" id="urlFetchBtn"><span class="material-icons">download</span> Hämta</button>
          </div>
        </div>

        <!-- Add to Existing Mode -->
        <div id="urlAddMode" class="hidden">
          <div style="margin-bottom: 16px;">
            <label>Välj befintlig samling</label>
            <select id="existingUrlCollectionSelect">
              <option value="">-- Välj samling --</option>
            </select>
          </div>

          <div style="margin-bottom: 16px;">
            <label>URLs att lägga till (en per rad)</label>
            <textarea id="addUrlInput" placeholder="https://exempel.se/ny-sida1&#10;https://exempel.se/ny-sida2"></textarea>
            <p class="text-muted" style="margin-top: 4px;">Ange en eller flera URLs, en per rad</p>
          </div>

          <div class="input-group">
            <div style="flex: 1;"><label>Embedding Model</label>
              <select id="addUrlEmbedBackend">
                <option value="google">Google Gemini</option>
                <option value="cohere">Cohere v3 ⭐ Robust mot brus</option>
                <option value="bge">BGE-M3 ⭐ State-of-the-art OSS</option>
                <option value="e5">E5 ⭐ Multilingual, bra för svenska</option>
                <option value="openai">OpenAI</option>
                <option value="sbert">SBERT</option>
                <option value="ollama">Ollama</option>
              </select>
            </div>
            <button class="btn btn-raised" id="addUrlFetchBtn"><span class="material-icons">add</span> Lägg till</button>
          </div>
        </div>

        <div id="urlProgress" style="display: none; margin-top: 16px;">
          <div style="background: #e0e0e0; border-radius: 4px; height: 8px; overflow: hidden;">
            <div id="urlProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
          </div>
          <p id="urlProgressText" class="text-muted" style="margin-top: 8px; text-align: center;">0 / 0</p>
        </div>

        <div id="urlResult" style="display:none; margin-top:20px">
          <div class="stats">
            <div class="stat-card"><div class="stat-label">Samling</div><div class="stat-value" id="urlCollectionNameDisplay">-</div></div>
            <div class="stat-card"><div class="stat-label">Totalt chunkar</div><div class="stat-value" id="urlRecordCount">-</div></div>
            <div class="stat-card"><div class="stat-label">Totalt vektorer</div><div class="stat-value" id="urlVectorCount">-</div></div>
          </div>
          <div id="urlListContainer" class="hidden">
            <h3><span class="material-icons">link</span> Indexerade URLs</h3>
            <div id="urlListDisplay" class="url-list"></div>
          </div>
        </div>
      </div>

      <!-- Search -->
        <!-- Göm i nuläget
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="margin: 0;">Semantisk Sökning</h2>
            <button class="btn btn-outlined" id="clearSearchBtn" style="text-transform: none;">
              <span class="material-icons">clear</span> Rensa
            </button>
          </div>
          <p class="text-muted">Sök i indexerat innehåll med naturligt språk.</p>
          <div class="input-group">
            <div style="flex: 1;"><label>Välj Samling</label><select id="searchCollection"><option value="">-- Välj --</option></select></div>
            <button class="btn btn-outlined" id="refreshCollections"><span class="material-icons">refresh</span> Uppdatera</button>
          </div>
          <div class="input-group" style="margin-top: 12px;">
            <div style="flex: 1;"><label>Sökfråga</label><input id="searchQuery" type="text" placeholder="Vad letar du efter?" /></div>
            <div style="width: 120px;"><label>Antal</label>
              <select id="searchK"><option value="3">Top 3</option><option value="5" selected>Top 5</option><option value="10">Top 10</option></select>
            </div>
            <button class="btn btn-raised" id="searchBtn"><span class="material-icons">search</span> Sök</button>
          </div>
          <div id="searchResults" style="margin-top: 24px;"></div>
        </div>
      -->

      <!-- ASK AI -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">Fråga AI</h2>
          <button class="btn btn-outlined" id="clearAskBtn" style="text-transform: none;">
            <span class="material-icons">clear</span> Rensa
          </button>
        </div>
        <p class="text-muted">Ställ frågor på naturligt språk. AI:n söker i dina dokument och formulerar ett svar.</p>
        <div class="input-group">
          <div style="flex: 1;"><label>Välj Samling</label><select id="askCollection"><option value="">-- Välj --</option></select></div>
          <div style="width: 180px;"><label>LLM-modell</label>
            <select id="llmBackend">
              <option value="google">Google Gemini</option>
              <option value="openai">OpenAI GPT</option>
              <option value="ollama">Ollama (Lokal)</option>
            </select>
          </div>
          <div style="width: 120px;"><label>Antal källor</label>
            <select id="askK"><option value="3">Top 3</option><option value="5" selected>Top 5</option><option value="10">Top 10</option></select>
          </div>
        </div>
        <div class="input-group" style="margin-top: 12px;">
          <div style="flex: 1;"><label>Din fråga</label><input id="askQuery" type="text" placeholder="Ställ en fråga om dokumentet..." /></div>
          <button class="btn btn-raised" id="askBtn"><span class="material-icons">send</span> Fråga</button>
        </div>
        <div id="askLoading" style="display: none; margin-top: 24px; text-align: center; padding: 32px;">
          <div class="spinner" style="width: 32px; height: 32px; border-width: 3px;"></div>
          <p style="margin-top: 16px; color: var(--on-surface-medium);">Söker i dokument och genererar svar...</p>
        </div>
        <div id="askAnswer" style="display: none; margin-top: 24px;">
          <div class="ai-answer-box">
            <div style="display: flex; gap: 12px;">
              <span class="material-icons" style="color: var(--secondary); font-size: 28px;">smart_toy</span>
              <div style="flex: 1;">
                <h4 style="margin: 0 0 12px; color: var(--secondary);">Svar från AI</h4>
                <div id="askAnswerText" class="ai-answer-text"></div>
              </div>
            </div>
          </div>
          <details style="margin-top: 16px;">
            <summary style="cursor: pointer; font-weight: 500; color: var(--primary);"><span class="material-icons" style="vertical-align: middle;">source</span> Visa källor som användes</summary>
            <div id="askSources" style="margin-top: 12px;"></div>
          </details>
        </div>
      </div>
    </div>

    <script>
      let currentPdfMode = 'new';
      let currentUrlMode = 'new';

      // ============= FELHANTERING =============
      function showError(errorData, context = '') {
        let message = '';
        
        if (errorData.error) {
          // Strukturerat felmeddelande från server
          message = errorData.error.message || errorData.error.details || 'Ett okänt fel uppstod';
          
          if (errorData.error.context) {
            message = `FEL VID ${errorData.error.context.toUpperCase()}:\n\n${message}`;
          }
        } else if (errorData.detail) {
          // HTTPException från FastAPI
          message = errorData.detail;
        } else if (typeof errorData === 'string') {
          // Enkel sträng
          message = errorData;
        } else {
          message = 'Ett okänt fel uppstod';
        }
        
        // Visa alert med felet
        alert(message);
        
        // Logga också till konsol för debugging
        console.error('Error:', errorData);
      }

      // Helper för att hantera fetch-errors
      async function handleFetchError(response) {
        let errorData;
        try {
          errorData = await response.json();
        } catch (e) {
          errorData = { error: { message: `HTTP ${response.status}: ${response.statusText}` } };
        }
        
        // Kolla om det är ett strukturerat fel
        if (errorData.success === false || errorData.error) {
          showError(errorData);
        } else {
          showError(errorData);
        }
        
        return errorData;
      }

      // PDF Mode switching
      document.getElementById('pdfModeNew').addEventListener('click', () => switchPdfMode('new'));
      document.getElementById('pdfModeAdd').addEventListener('click', () => switchPdfMode('add'));

      // URL Mode switching
      document.getElementById('urlModeNew').addEventListener('click', () => switchUrlMode('new'));
      document.getElementById('urlModeAdd').addEventListener('click', () => switchUrlMode('add'));

      function switchPdfMode(mode) {
        currentPdfMode = mode;
        document.getElementById('pdfModeNew').classList.remove('active');
        document.getElementById('pdfModeAdd').classList.remove('active');
        
        document.getElementById('pdfNewMode').classList.add('hidden');
        document.getElementById('pdfAddMode').classList.add('hidden');

        if (mode === 'new') {
          document.getElementById('pdfModeNew').classList.add('active');
          document.getElementById('pdfNewMode').classList.remove('hidden');
        } else if (mode === 'add') {
          document.getElementById('pdfModeAdd').classList.add('active');
          document.getElementById('pdfAddMode').classList.remove('hidden');
          refreshExistingPdfCollections();
        }
      }

      function switchUrlMode(mode) {
        currentUrlMode = mode;
        document.getElementById('urlModeNew').classList.remove('active');
        document.getElementById('urlModeAdd').classList.remove('active');
        
        document.getElementById('urlNewMode').classList.add('hidden');
        document.getElementById('urlAddMode').classList.add('hidden');

        if (mode === 'new') {
          document.getElementById('urlModeNew').classList.add('active');
          document.getElementById('urlNewMode').classList.remove('hidden');
        } else if (mode === 'add') {
          document.getElementById('urlModeAdd').classList.add('active');
          document.getElementById('urlAddMode').classList.remove('hidden');
          refreshExistingUrlCollections();
        }
      }

      // PDF Upload - New Collection Mode
      const pdfDropzone = document.getElementById('pdfDropzone');
      const pdfFileInput = document.getElementById('pdfFile');
      const pdfCollectionNameInput = document.getElementById('pdfCollectionName');

      async function handlePdfFiles(files, collectionName = null) {
        if (!files || files.length === 0) { 
          showError('Välj minst en PDF-fil', 'PDF-val'); 
          return; 
        }

        const colName = collectionName || pdfCollectionNameInput.value.trim();
        const backend = document.getElementById('pdfEmbedBackend').value;
        const chunk = document.getElementById('pdfChunkSize').value;
        const progress = document.getElementById('pdfProgress');
        const progressBar = document.getElementById('pdfProgressBar');
        const progressText = document.getElementById('pdfProgressText');

        progress.style.display = 'block';
        let completed = 0;
        let lastData = null;
        let errors = [];

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (!file.name.toLowerCase().endsWith('.pdf')) {
            errors.push(`${file.name}: Inte en PDF-fil`);
            continue;
          }
          
          try {
            progressText.textContent = `${completed} / ${files.length} - Laddar upp ${file.name}`;
            
            const form = new FormData();
            form.append('file', file);
            let url = '/api/upload_pdf?embed_backend=' + backend + '&max_tokens_per_chunk=' + chunk;
            if (colName) {
              url += '&collection_name=' + encodeURIComponent(colName);
            }
            
            const res = await fetch(url, { method: 'POST', body: form });
            
            if (!res.ok) {
              const errorData = await handleFetchError(res);
              errors.push(`${file.name}: ${errorData.error?.message || 'Okänt fel'}`);
              continue;
            }
            
            const data = await res.json();
            
            if (data.success === false) {
              showError(data);
              errors.push(`${file.name}: Processering misslyckades`);
              continue;
            }
            
            lastData = data;
            completed++;
            progressBar.style.width = `${(completed / files.length) * 100}%`;
            progressText.textContent = `${completed} / ${files.length}`;
          } catch (e) {
            console.error(`Fel vid ${file.name}:`, e);
            errors.push(`${file.name}: ${e.message}`);
          }
        }

        if (errors.length > 0) {
          showError(`Några filer kunde inte processas:\n\n${errors.join('\n')}`);
        }

        progressText.textContent = `Klart! ${completed} / ${files.length} PDFs indexerade`;
        
        if (lastData) {
          displayPdfResults(lastData);
        }
        
        pdfCollectionNameInput.value = '';
        refreshAllCollections();
        setTimeout(() => { progress.style.display = 'none'; progressBar.style.width = '0%'; }, 3000);
      }

      ['dragenter','dragover'].forEach(e => pdfDropzone.addEventListener(e, ev => { ev.preventDefault(); pdfDropzone.classList.add('dragover'); }));
      ['dragleave','drop'].forEach(e => pdfDropzone.addEventListener(e, ev => { ev.preventDefault(); pdfDropzone.classList.remove('dragover'); }));
      pdfDropzone.addEventListener('drop', e => handlePdfFiles(e.dataTransfer.files));
      pdfFileInput.addEventListener('change', e => handlePdfFiles(e.target.files));

      // PDF Upload - Add to Existing Mode
      const addPdfDropzone = document.getElementById('addPdfDropzone');
      const addPdfFileInput = document.getElementById('addPdfFile');

      async function handleAddPdfFiles(files) {
        const collection = document.getElementById('existingPdfCollectionSelect').value;
        if (!collection) { alert('Välj en samling.'); return; }
        if (!files || files.length === 0) { alert('Välj minst en PDF-fil.'); return; }

        await handlePdfFiles(files, collection);
      }

      ['dragenter','dragover'].forEach(e => addPdfDropzone.addEventListener(e, ev => { ev.preventDefault(); addPdfDropzone.classList.add('dragover'); }));
      ['dragleave','drop'].forEach(e => addPdfDropzone.addEventListener(e, ev => { ev.preventDefault(); addPdfDropzone.classList.remove('dragover'); }));
      addPdfDropzone.addEventListener('drop', e => handleAddPdfFiles(e.dataTransfer.files));
      addPdfFileInput.addEventListener('change', e => handleAddPdfFiles(e.target.files));

      function displayPdfResults(data) {
        document.getElementById('pdfCollectionNameDisplay').textContent = data.collection_name;
        document.getElementById('pdfRecordCount').textContent = data.record_count || data.total_records || 0;
        document.getElementById('pdfVectorCount').textContent = data.vector_store?.stats?.total_vectors || data.total_vectors || 0;
        document.getElementById('pdfResult').style.display = 'block';

        if (data.indexed_pdfs && data.indexed_pdfs.length > 0) {
          const pdfListContainer = document.getElementById('pdfListContainer');
          const pdfListDisplay = document.getElementById('pdfListDisplay');
          pdfListContainer.classList.remove('hidden');
          pdfListDisplay.innerHTML = data.indexed_pdfs.map(p => 
            `<div class="url-item"><span class="material-icons" style="font-size: 16px; color: var(--secondary);">description</span><span class="url-item-text">${p}</span></div>`
          ).join('');
        }
      }

      async function refreshExistingPdfCollections() {
        try {
          const res = await fetch('/api/collections');
          const data = await res.json();
          const sel = document.getElementById('existingPdfCollectionSelect');
          sel.innerHTML = '<option value="">-- Välj samling --</option>';
          data.collections.forEach(c => {
            const o = document.createElement('option');
            o.value = c.name;
            o.textContent = c.name;
            sel.appendChild(o);
          });
        } catch (e) { console.error(e); }
      }

      // URL Fetch - New Collection Mode
      document.getElementById('urlFetchBtn').addEventListener('click', async () => {
        const urls = document.getElementById('urlInput').value.trim().split('\n').filter(u => u.trim());
        const collectionName = document.getElementById('urlCollectionName').value.trim();
        const backend = document.getElementById('urlEmbedBackend').value;

        if (urls.length === 0) { alert('Ange minst en URL.'); return; }

        await fetchUrls(urls, collectionName, backend);
      });

      // URL Fetch - Add to Existing Mode
      document.getElementById('addUrlFetchBtn').addEventListener('click', async () => {
        const urls = document.getElementById('addUrlInput').value.trim().split('\n').filter(u => u.trim());
        const collection = document.getElementById('existingUrlCollectionSelect').value;
        const backend = document.getElementById('addUrlEmbedBackend').value;

        if (!collection) { alert('Välj en samling.'); return; }
        if (urls.length === 0) { alert('Ange minst en URL.'); return; }

        await fetchUrls(urls, collection, backend);
      });

      async function fetchUrls(urls, collectionName, backend) {
        const btn = document.getElementById(currentUrlMode === 'new' ? 'urlFetchBtn' : 'addUrlFetchBtn');
        const progress = document.getElementById('urlProgress');
        const progressBar = document.getElementById('urlProgressBar');
        const progressText = document.getElementById('urlProgressText');

        btn.disabled = true;
        progress.style.display = 'block';

        let completed = 0;
        let lastData = null;
        let errors = [];

        for (const url of urls) {
          if (!url.trim()) continue;
          try {
            progressText.textContent = `${completed} / ${urls.length} - Hämtar ${url}`;
            
            const payload = { 
              url: url.trim(), 
              embed_backend: backend 
            };
            if (collectionName) {
              payload.collection_name = collectionName;
            }

            const res = await fetch('/api/fetch_url', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            
            if (!res.ok) {
              const errorData = await handleFetchError(res);
              errors.push(`${url}: ${errorData.error?.message || 'Okänt fel'}`);
              continue;
            }
            
            const data = await res.json();
            
            if (data.success === false) {
              showError(data);
              errors.push(`${url}: Processering misslyckades`);
              continue;
            }
            
            lastData = data;
            completed++;
            progressBar.style.width = `${(completed / urls.length) * 100}%`;
            progressText.textContent = `${completed} / ${urls.length}`;
          } catch (e) {
            console.error(`Fel vid ${url}:`, e);
            errors.push(`${url}: ${e.message}`);
          }
        }

        if (errors.length > 0) {
          showError(`Några URLs kunde inte processas:\n\n${errors.join('\n')}`);
        }

        progressText.textContent = `Klart! ${completed} / ${urls.length} URLs indexerade`;
        btn.disabled = false;
        
        if (lastData) {
          displayUrlResults(lastData);
        }

        // Clear inputs
        if (currentUrlMode === 'new') {
          document.getElementById('urlInput').value = '';
          document.getElementById('urlCollectionName').value = '';
        } else {
          document.getElementById('addUrlInput').value = '';
        }

        refreshAllCollections();
        setTimeout(() => { progress.style.display = 'none'; progressBar.style.width = '0%'; }, 3000);
      }

      function displayUrlResults(data) {
        document.getElementById('urlCollectionNameDisplay').textContent = data.collection_name;
        document.getElementById('urlRecordCount').textContent = data.record_count || data.total_records || 0;
        document.getElementById('urlVectorCount').textContent = data.vector_store?.stats?.total_vectors || data.total_vectors || 0;
        document.getElementById('urlResult').style.display = 'block';

        if (data.indexed_urls && data.indexed_urls.length > 0) {
          const urlListContainer = document.getElementById('urlListContainer');
          const urlListDisplay = document.getElementById('urlListDisplay');
          urlListContainer.classList.remove('hidden');
          urlListDisplay.innerHTML = data.indexed_urls.map(u => 
            `<div class="url-item"><span class="material-icons" style="font-size: 16px; color: var(--secondary);">link</span><span class="url-item-text">${u}</span></div>`
          ).join('');
        }
      }

      async function refreshExistingUrlCollections() {
        try {
          const res = await fetch('/api/collections');
          const data = await res.json();
          const sel = document.getElementById('existingUrlCollectionSelect');
          sel.innerHTML = '<option value="">-- Välj samling --</option>';
          data.collections.forEach(c => {
            const o = document.createElement('option');
            o.value = c.name;
            o.textContent = c.name;
            sel.appendChild(o);
          });
        } catch (e) { console.error(e); }
      }

      const searchEls = {
        collection: document.getElementById('searchCollection'),
        query: document.getElementById('searchQuery'),
        k: document.getElementById('searchK'),
        btn: document.getElementById('searchBtn'),
        results: document.getElementById('searchResults'),
        refresh: document.getElementById('refreshCollections'),
      };

      const askEls = {
        collection: document.getElementById('askCollection'),
        query: document.getElementById('askQuery'),
        k: document.getElementById('askK'),
        llm: document.getElementById('llmBackend'),
        btn: document.getElementById('askBtn'),
        answer: document.getElementById('askAnswer'),
        answerText: document.getElementById('askAnswerText'),
        sources: document.getElementById('askSources'),
        loading: document.getElementById('askLoading'),
      };

      async function refreshAllCollections() {
        try {
          const res = await fetch('/api/collections');
          const data = await res.json();
          [searchEls.collection, askEls.collection].forEach(sel => {
            const val = sel.value;
            sel.innerHTML = '<option value="">-- Välj samling --</option>';
            data.collections.forEach(c => {
              const o = document.createElement('option');
              o.value = c.name;
              o.textContent = c.name + (c.loaded ? ' ✓' : '');
              sel.appendChild(o);
            });
            if (val) sel.value = val;
          });
        } catch (e) { console.error(e); }
      }

      searchEls.btn.addEventListener('click', async () => {
        const col = searchEls.collection.value, q = searchEls.query.value.trim(), k = searchEls.k.value;
        if (!col) { showError('Välj en samling', 'sökning'); return; }
        if (!q) { showError('Ange sökfråga', 'sökning'); return; }
        searchEls.results.innerHTML = '<p><span class="spinner"></span> Söker...</p>';
        try {
          const res = await fetch('/api/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ collection: col, query: q, k: parseInt(k) })
          });
          
          if (!res.ok) {
            await handleFetchError(res);
            searchEls.results.innerHTML = '<p style="color:var(--error);">Sökningen misslyckades</p>';
            return;
          }
          
          const data = await res.json();
          
          if (data.success === false) {
            showError(data);
            searchEls.results.innerHTML = '<p style="color:var(--error);">Sökningen misslyckades</p>';
            return;
          }
          
          if (!data.results?.length) {
            searchEls.results.innerHTML = '<div class="empty-state"><span class="material-icons">search_off</span><p>Inga resultat.</p></div>';
            return;
          }
          let html = '<h3>' + data.results_count + ' resultat</h3>';
          data.results.forEach(r => {
            html += '<div class="search-result"><div class="search-result-header"><h4 class="search-result-title">' + (r.heading || 'Utan titel') + '</h4><span class="search-result-score">' + r.score + '</span></div><div class="search-result-text">' + r.markdown + '</div></div>';
          });
          searchEls.results.innerHTML = html;
        } catch (e) { 
          searchEls.results.innerHTML = '<p style="color:var(--error);">Fel: ' + e.message + '</p>'; 
          showError(e.message, 'sökning');
        }
      });

      searchEls.refresh.addEventListener('click', refreshAllCollections);
      searchEls.query.addEventListener('keypress', e => { if (e.key === 'Enter') searchEls.btn.click(); });

      askEls.btn.addEventListener('click', async () => {
        const col = askEls.collection.value, q = askEls.query.value.trim(), k = askEls.k.value, llm = askEls.llm.value;
        if (!col) { showError('Välj en samling', 'AI-fråga'); return; }
        if (!q) { showError('Skriv en fråga', 'AI-fråga'); return; }
        askEls.answer.style.display = 'none';
        askEls.loading.style.display = 'block';
        askEls.btn.disabled = true;
        try {
          const res = await fetch('/api/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ collection: col, query: q, k: parseInt(k), llm_backend: llm })
          });
          
          if (!res.ok) {
            await handleFetchError(res);
            askEls.loading.style.display = 'none';
            askEls.answer.style.display = 'block';
            askEls.answerText.textContent = 'AI-frågan misslyckades. Se felmeddelandet ovan.';
            askEls.sources.innerHTML = '';
            askEls.btn.disabled = false;
            return;
          }
          
          const data = await res.json();
          
          if (data.success === false) {
            showError(data);
            askEls.loading.style.display = 'none';
            askEls.answer.style.display = 'block';
            askEls.answerText.textContent = 'AI-frågan misslyckades. Se felmeddelandet ovan.';
            askEls.sources.innerHTML = '';
            askEls.btn.disabled = false;
            return;
          }
          
          askEls.answerText.textContent = data.answer;
          let srcHtml = '';
          if (data.sources?.length) {
            data.sources.forEach(s => {
              srcHtml += '<div class="search-result"><div class="search-result-header"><h4 class="search-result-title">' + (s.heading || 'Källa ' + s.rank) + '</h4><span class="search-result-score">' + s.score + '</span></div><div class="search-result-text">' + s.preview + '</div></div>';
            });
          } else {
            srcHtml = '<p class="text-muted">Inga källor.</p>';
          }
          askEls.sources.innerHTML = srcHtml;
          askEls.loading.style.display = 'none';
          askEls.answer.style.display = 'block';
        } catch (e) {
          askEls.loading.style.display = 'none';
          askEls.answer.style.display = 'block';
          askEls.answerText.textContent = 'Fel: ' + e.message;
          askEls.sources.innerHTML = '';
          showError(e.message, 'AI-fråga');
        }
        askEls.btn.disabled = false;
      });

      askEls.query.addEventListener('keypress', e => { if (e.key === 'Enter') askEls.btn.click(); });

      // Clear buttons functionality
      document.getElementById('clearPdfBtn').addEventListener('click', () => {
        pdfCollectionNameInput.value = '';
        pdfFileInput.value = '';
        addPdfFileInput.value = '';
        document.getElementById('existingPdfCollectionSelect').value = '';
        document.getElementById('pdfProgress').style.display = 'none';
        document.getElementById('pdfProgressBar').style.width = '0%';
        document.getElementById('pdfProgressText').textContent = '0 / 0';
        document.getElementById('pdfResult').style.display = 'none';
        document.getElementById('pdfListContainer').classList.add('hidden');
        document.getElementById('pdfListDisplay').innerHTML = '';
      });

      document.getElementById('clearUrlBtn').addEventListener('click', () => {
        document.getElementById('urlInput').value = '';
        document.getElementById('urlCollectionName').value = '';
        document.getElementById('addUrlInput').value = '';
        document.getElementById('existingUrlCollectionSelect').value = '';
        document.getElementById('urlProgress').style.display = 'none';
        document.getElementById('urlProgressBar').style.width = '0%';
        document.getElementById('urlProgressText').textContent = '0 / 0';
        document.getElementById('urlResult').style.display = 'none';
        document.getElementById('urlListContainer').classList.add('hidden');
        document.getElementById('urlListDisplay').innerHTML = '';
      });

      document.getElementById('clearSearchBtn').addEventListener('click', () => {
        searchEls.collection.value = '';
        searchEls.query.value = '';
        searchEls.results.innerHTML = '';
      });

      document.getElementById('clearAskBtn').addEventListener('click', () => {
        askEls.collection.value = '';
        askEls.query.value = '';
        askEls.answer.style.display = 'none';
        askEls.loading.style.display = 'none';
        askEls.answerText.textContent = '';
        askEls.sources.innerHTML = '';
      });

      refreshAllCollections();
    </script>
  </body>
</html>